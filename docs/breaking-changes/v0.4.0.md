# Breaking Change: v0.4.0

## CAPTCHA Sessions Moved from In-Memory to Stateless JWTs

CAPTCHA sessions moved from in-memory cache to stateless JWTs. This change was made to support multiple replicas of the bouncer in addition to not losing state if a pod restarts. Because we are using cookies, this requires additional configuration of the bouncer.

If you use CAPTCHA, you must update your config.

If you are using the bouncer to protect multiple domains, you must use a bouncer per domain to set the cookie.

## What Changed

v0.3.1 stored sessions in memory with random session IDs. v0.4.0 uses JWTs instead.

The new flow:
1. User hits CAPTCHA and gets a challenge token (JWT)
2. User completes CAPTCHA and gets a verification token (JWT)
3. Verification token stored in a cookie

## New Required Fields

If CAPTCHA is enabled, add these to your config:

signingKey - Signs the JWTs. Must be at least 32 bytes.

```bash
openssl rand -base64 32
```

cookieDomain - The parent domain for the cookie

For example, `.example.com` cookies would work for `auth.example.com` and `app.example.com`.

secureCookie - Defaults to true

## Removed Field

`cacheCleanupInterval` is no longer used

## How to Migrate

Generate a signing key:

```bash
openssl rand -base64 32
```

Update config with new fields:

```yaml
captcha:
  enabled: true
  provider: "recaptcha"
  siteKey: "your-site-key"
  secretKey: "your-secret-key"
  signingKey: "your-generated-signing-key"
  callbackURL: "https://auth.example.com"
  cookieDomain: ".example.com"
  secureCookie: true
  sessionDuration: "15m"
  challengeDuration: "5m"
```

Update Helm values:

```yaml
config:
  captcha:
    enabled: true
    provider: "recaptcha"
    siteKey: "6LeIxA..."
    secretKeySecretRef:
      name: captcha-secrets
      key: secret-key
    signingKeySecretRef:
      name: captcha-secrets
      key: signing-key
    callbackURL: "https://auth.example.com"
    cookieDomain: ".example.com"
    secureCookie: true
```

Add environment variables:

```bash
export ENVOY_BOUNCER_CAPTCHA_SIGNINGKEY=your-signing-key
export ENVOY_BOUNCER_CAPTCHA_COOKIEDOMAIN=.example.com
export ENVOY_BOUNCER_CAPTCHA_SECURECOOKIE=true
```

## Cookie Domain Setup

The `cookieDomain` needs a leading dot to work across subdomains.

If your bouncer is at `auth.example.com` and your app is at `app.example.com`, use `.example.com`. The cookie set by the bouncer will be readable by your app.

## See Also

- [CAPTCHA Configuration](../CAPTCHA.md)
- [Configuration Guide](../CONFIGURATION.md)
- [Deployment Guide](../DEPLOYMENT.md)
