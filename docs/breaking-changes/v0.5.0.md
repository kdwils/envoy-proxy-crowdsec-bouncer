# Breaking Change: v0.5.0

## CAPTCHA API and Cookie Changes

v0.5.0 refactors the JWT implementation to improve security and simplify the token structure. If you use custom CAPTCHA HTML templates, you must update them.

## What Changed

### Query Parameter Rename

The query parameter used to pass the challenge token to the captcha page changed:

| v0.4.x | v0.5.0 |
|--------|--------|
| `?session=...` | `?challengeToken=...` |

### Form Field Changes

Form field names are now standardized across all CAPTCHA providers:

| v0.4.x | v0.5.0 |
|--------|--------|
| `session` | `challengeToken` |
| `g-recaptcha-response` (reCAPTCHA) | `captchaResponse` |
| `cf-turnstile-response` (Turnstile) | `captchaResponse` |

### Cookie Name Change

The session cookie name changed:

| v0.4.x | v0.5.0 |
|--------|-----------------------------|
| `captcha_verified` | `session` |

The `cookieName` config option can override this default.

### Session Token Structure

Session tokens no longer contain IP addresses. IP binding is enforced only during challenge token verification. Once a session token is issued, it can be used from any IP.

## How to Migrate Custom Templates

If you use the default embedded templates, no action is required.

If you use custom CAPTCHA templates via the `captchaTemplatePath` config option, update them.

### reCAPTCHA Template Migration

**Before (v0.4.x):**

```html
<form action="{{.CallbackURL}}/verify" method="POST">
    <input type="hidden" name="session" value="{{.SessionID}}">
    <div class="g-recaptcha" data-sitekey="{{.SiteKey}}" data-callback="onCaptchaSuccess"></div>
</form>

<script>
function onCaptchaSuccess(response) {
    document.querySelector('form').submit();
}
</script>
```

**After (v0.5.0):**

```html
<form action="{{.CallbackURL}}/verify" method="POST">
    <input type="hidden" name="challengeToken" value="{{.ChallengeToken}}">
    <input type="hidden" name="captchaResponse" id="captchaResponse">
    <div class="g-recaptcha" data-sitekey="{{.SiteKey}}" data-callback="onCaptchaSuccess"></div>
</form>

<script>
function onCaptchaSuccess(response) {
    document.getElementById('captchaResponse').value = response;
    document.querySelector('form').submit();
}
</script>
```

### Turnstile Template Migration

**Before (v0.4.x):**

```html
<form action="{{.CallbackURL}}/verify" method="POST">
    <input type="hidden" name="session" value="{{.SessionID}}">
    <div class="cf-turnstile" data-sitekey="{{.SiteKey}}" data-callback="onCaptchaSuccess"></div>
</form>

<script>
function onCaptchaSuccess(response) {
    document.querySelector('form').submit();
}
</script>
```

**After (v0.5.0):**

```html
<form action="{{.CallbackURL}}/verify" method="POST">
    <input type="hidden" name="challengeToken" value="{{.ChallengeToken}}">
    <input type="hidden" name="captchaResponse" id="captchaResponse">
    <div class="cf-turnstile" data-sitekey="{{.SiteKey}}" data-callback="onCaptchaSuccess"></div>
</form>

<script>
function onCaptchaSuccess(response) {
    document.getElementById('captchaResponse').value = response;
    document.querySelector('form').submit();
}
</script>
```

## Template Variable Changes

| v0.4.x | v0.5.0 |
|--------|--------|
| `{{.SessionID}}` | `{{.ChallengeToken}}` |

## New Config Option

`cookieName` - Override the default session cookie name.

```yaml
captcha:
  cookieName: "my-session"
```

## Security Improvements

- Challenge tokens use HMAC-SHA256 hashed IPs instead of plain text IPs
- Challenge tokens include a unique ID for replay protection
- Challenge tokens can only be used once
- Session tokens no longer contain IP addresses

## See Also

- [CAPTCHA Configuration](../CAPTCHA.md)
- [Configuration Guide](../CONFIGURATION.md)
- [v0.4.0 Breaking Changes](v0.4.0.md)
